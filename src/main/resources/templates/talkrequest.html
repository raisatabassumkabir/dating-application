<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Messages - BiyeShaddi.com</title>
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}" />
  <link rel="stylesheet" type="text/css" th:href="@{/css/variables.css}" />
  <link rel="stylesheet" type="text/css" th:href="@{/css/dashboard.css}" />
  <script th:src="@{/js/theme.js}"></script>

  <style>
    /* ===== CHAT PAGE LAYOUT ===== */
    .chat-page {
      display: grid;
      grid-template-columns: 380px 1fr;
      height: calc(100vh - 100px);
      background: var(--bg-white);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(0, 0, 0, 0.04);
    }

    /* ===== LEFT PANEL ===== */
    .panel-left {
      display: flex;
      flex-direction: column;
      border-right: 1px solid rgba(0, 0, 0, 0.06);
      background: var(--bg-white);
      overflow: hidden;
    }

    .panel-header {
      padding: 22px 24px 16px;
      flex-shrink: 0;
    }

    .panel-title {
      font-family: var(--font-heading);
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 16px;
      letter-spacing: -0.02em;
    }

    /* ===== TABS ===== */
    .tab-bar {
      display: flex;
      gap: 4px;
      background: var(--bg-light);
      padding: 4px;
      border-radius: var(--radius-xl);
      flex-shrink: 0;
    }

    .tab-btn {
      flex: 1;
      padding: 10px 6px;
      text-align: center;
      cursor: pointer;
      border: none;
      background: transparent;
      border-radius: 20px;
      font-family: var(--font-body);
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text-light);
      transition: var(--transition-fast);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .tab-btn:hover {
      color: var(--text-body);
      background: rgba(255, 255, 255, 0.6);
    }

    .tab-btn.active {
      background: var(--bg-white);
      color: var(--primary-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .tab-count {
      background: var(--primary-color);
      color: white;
      font-size: 0.6rem;
      min-width: 16px;
      height: 16px;
      border-radius: var(--radius-full);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      padding: 0 4px;
      line-height: 1;
    }

    .tab-btn.active .tab-count {
      background: var(--primary-color);
    }

    /* ===== SEARCH BAR ===== */
    .search-bar {
      margin: 14px 20px 6px;
      position: relative;
      flex-shrink: 0;
    }

    .search-bar input {
      width: 100%;
      padding: 10px 14px 10px 38px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: var(--radius-xl);
      font-family: var(--font-body);
      font-size: 0.85rem;
      background: var(--bg-light);
      color: var(--text-main);
      outline: none;
      transition: var(--transition-fast);
      box-sizing: border-box;
    }

    .search-bar input:focus {
      border-color: var(--primary-color);
      background: var(--bg-white);
      box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
    }

    .search-bar i {
      position: absolute;
      left: 13px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
      font-size: 0.85rem;
    }

    /* ===== CONVERSATION LIST ===== */
    .convo-list {
      flex: 1;
      overflow-y: auto;
      padding: 6px 8px;
    }

    .convo-list::-webkit-scrollbar {
      width: 4px;
    }

    .convo-list::-webkit-scrollbar-thumb {
      background: #ddd;
      border-radius: 4px;
    }

    .list-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 50px 30px;
      text-align: center;
    }

    .list-empty .empty-icon {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.08), rgba(255, 183, 77, 0.08));
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }

    .list-empty .empty-icon i {
      font-size: 1.6rem;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .list-empty p {
      color: var(--text-light);
      font-size: 0.88rem;
      line-height: 1.5;
    }

    .list-empty p strong {
      color: var(--text-body);
    }

    /* ===== CHAT ITEM (Conversation List) ===== */
    .convo-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 16px;
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.15s ease;
      margin-bottom: 2px;
      position: relative;
    }

    .convo-item:hover {
      background: var(--bg-light);
    }

    .convo-item.selected {
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.06), rgba(255, 183, 77, 0.04));
    }

    .convo-item.selected::before {
      content: '';
      position: absolute;
      left: 0;
      top: 12px;
      bottom: 12px;
      width: 3px;
      border-radius: 0 3px 3px 0;
      background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
    }

    /* Avatar */
    .avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-heading);
      font-weight: 700;
      font-size: 1.15rem;
      color: white;
      position: relative;
    }

    .avatar.gradient-1 {
      background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
    }

    .avatar.gradient-2 {
      background: linear-gradient(135deg, #4dabf7, #3b5998);
    }

    .avatar.gradient-3 {
      background: linear-gradient(135deg, #51cf66, #2f9e44);
    }

    .avatar.gradient-4 {
      background: linear-gradient(135deg, #ffa94d, #e67700);
    }

    .avatar.gradient-5 {
      background: linear-gradient(135deg, #cc5de8, #862ae9);
    }

    .avatar.gradient-6 {
      background: linear-gradient(135deg, #ff922b, #f06595);
    }

    .avatar-sm {
      width: 42px;
      height: 42px;
      font-size: 0.95rem;
    }

    .online-indicator {
      position: absolute;
      bottom: 1px;
      right: 1px;
      width: 12px;
      height: 12px;
      background: var(--success-color);
      border: 2.5px solid white;
      border-radius: 50%;
    }

    .convo-details {
      flex: 1;
      min-width: 0;
    }

    .convo-name {
      font-weight: 600;
      font-size: 0.92rem;
      color: var(--text-main);
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .convo-preview {
      font-size: 0.8rem;
      color: var(--text-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    .convo-meta {
      text-align: right;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 5px;
    }

    .convo-time {
      font-size: 0.7rem;
      color: var(--text-light);
      font-weight: 500;
    }

    .unread-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), #ee5a6f);
      color: white;
      font-size: 0.6rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ===== REQUEST ITEMS ===== */
    .req-card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      border-radius: var(--radius-lg);
      margin-bottom: 4px;
      transition: var(--transition-fast);
    }

    .req-card:hover {
      background: var(--bg-light);
    }

    .req-details {
      flex: 1;
      min-width: 0;
    }

    .req-name {
      font-weight: 600;
      font-size: 0.92rem;
      color: var(--text-main);
      margin-bottom: 2px;
    }

    .req-sub {
      font-size: 0.78rem;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .req-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .btn-action {
      border: none;
      border-radius: var(--radius-full);
      padding: 8px 16px;
      font-family: var(--font-body);
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .btn-accept {
      background: linear-gradient(135deg, #51cf66, #2f9e44);
      color: white;
    }

    .btn-accept:hover {
      box-shadow: 0 4px 14px rgba(81, 207, 102, 0.35);
      transform: translateY(-1px);
    }

    .btn-reject {
      background: var(--bg-light);
      color: var(--text-light);
    }

    .btn-reject:hover {
      background: #f0f0f0;
      color: var(--text-body);
    }

    .badge-accepted {
      background: rgba(81, 207, 102, 0.1);
      color: #2f9e44;
      padding: 5px 12px;
      border-radius: var(--radius-full);
      font-size: 0.72rem;
      font-weight: 600;
    }

    .badge-status {
      font-size: 0.72rem;
      padding: 5px 12px;
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .badge-pending {
      background: #fff8e1;
      color: #f59f00;
    }

    .badge-accepted-sm {
      background: #ebfbee;
      color: #2f9e44;
    }

    .badge-rejected-sm {
      background: #fff0f0;
      color: #e03131;
    }

    .btn-chat-sm {
      background: linear-gradient(135deg, var(--primary-color), #ee5a6f);
      color: white;
      border: none;
      border-radius: var(--radius-full);
      padding: 7px 14px;
      font-family: var(--font-body);
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .btn-chat-sm:hover {
      box-shadow: 0 4px 14px rgba(255, 107, 107, 0.35);
      transform: translateY(-1px);
    }

    /* ===== RIGHT PANEL (CHAT AREA) ===== */
    .panel-right {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: linear-gradient(180deg, #fafbfc 0%, #f5f6f8 100%);
    }

    /* Empty state */
    .chat-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 40px;
      text-align: center;
    }

    .placeholder-illustration {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.07), rgba(255, 183, 77, 0.07));
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
      position: relative;
    }

    .placeholder-illustration::after {
      content: '';
      position: absolute;
      inset: -8px;
      border-radius: 50%;
      border: 2px dashed rgba(255, 107, 107, 0.15);
      animation: spin 20s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .placeholder-illustration i {
      font-size: 3rem;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .placeholder-title {
      font-family: var(--font-heading);
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 8px;
    }

    .placeholder-desc {
      font-size: 0.88rem;
      color: var(--text-light);
      max-width: 280px;
      line-height: 1.5;
    }

    /* Chat Header */
    .chat-top-bar {
      padding: 16px 28px;
      background: var(--bg-white);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      gap: 14px;
      flex-shrink: 0;
    }

    .chat-top-info h4 {
      font-family: var(--font-heading);
      font-weight: 700;
      font-size: 1rem;
      color: var(--text-main);
      margin: 0 0 2px 0;
    }

    .chat-top-info span {
      font-size: 0.76rem;
      color: var(--success-color);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .chat-top-info .dot-online {
      width: 7px;
      height: 7px;
      background: var(--success-color);
      border-radius: 50%;
      display: inline-block;
      animation: pulse-dot 2s infinite;
    }

    @keyframes pulse-dot {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.4;
      }
    }

    .chat-top-actions {
      margin-left: auto;
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: none;
      background: var(--bg-light);
      color: var(--text-light);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      transition: var(--transition-fast);
    }

    .icon-btn:hover {
      background: rgba(255, 107, 107, 0.08);
      color: var(--primary-color);
    }

    /* Messages Area */
    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 24px 28px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .messages-area::-webkit-scrollbar {
      width: 5px;
    }

    .messages-area::-webkit-scrollbar-thumb {
      background: #e0e0e0;
      border-radius: 5px;
    }

    .bubble {
      max-width: 65%;
      padding: 12px 18px;
      font-size: 0.9rem;
      line-height: 1.5;
      word-wrap: break-word;
      position: relative;
      animation: fadeInUp 0.25s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .bubble-out {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--primary-color), #ee5a6f);
      color: white;
      border-radius: 20px 20px 6px 20px;
      box-shadow: 0 2px 12px rgba(255, 107, 107, 0.2);
    }

    .bubble-in {
      align-self: flex-start;
      background: var(--bg-white);
      color: var(--text-main);
      border-radius: 20px 20px 20px 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .bubble-ts {
      font-size: 0.65rem;
      margin-top: 5px;
      opacity: 0.65;
    }

    .bubble-out .bubble-ts {
      text-align: right;
      color: rgba(255, 255, 255, 0.8);
    }

    .bubble-in .bubble-ts {
      color: var(--text-light);
    }

    .date-separator {
      text-align: center;
      margin: 16px 0;
    }

    .date-separator span {
      font-size: 0.72rem;
      color: var(--text-light);
      background: rgba(0, 0, 0, 0.03);
      padding: 5px 14px;
      border-radius: var(--radius-full);
      font-weight: 500;
    }

    .msg-welcome {
      text-align: center;
      padding: 60px 30px;
      color: var(--text-light);
    }

    .msg-welcome i {
      font-size: 2.4rem;
      display: block;
      margin-bottom: 12px;
      color: #e0e0e0;
    }

    /* Input Bar */
    .compose-bar {
      padding: 16px 24px;
      background: var(--bg-white);
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .compose-input {
      flex: 1;
      padding: 13px 20px;
      border: 1.5px solid rgba(0, 0, 0, 0.06);
      border-radius: var(--radius-full);
      font-family: var(--font-body);
      font-size: 0.9rem;
      outline: none;
      background: var(--bg-light);
      color: var(--text-main);
      transition: var(--transition-fast);
    }

    .compose-input:focus {
      border-color: var(--primary-color);
      background: white;
      box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.08);
    }

    .compose-input::placeholder {
      color: #bbb;
    }

    .send-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--primary-color), #ee5a6f);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.05rem;
      flex-shrink: 0;
      transition: all 0.2s ease;
      box-shadow: 0 4px 14px rgba(255, 107, 107, 0.3);
    }

    .send-btn:hover {
      transform: scale(1.06);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
    }

    .send-btn:active {
      transform: scale(0.96);
    }

    .send-btn:disabled {
      opacity: 0.4;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    /* ===== TOAST ===== */
    .toast-msg {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(16px);
      padding: 12px 24px;
      border-radius: var(--radius-xl);
      font-family: var(--font-body);
      font-size: 0.85rem;
      font-weight: 500;
      color: white;
      background: var(--text-main);
      box-shadow: var(--shadow-lg);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 9999;
      pointer-events: none;
    }

    /* ===== MESSAGE REQUEST PROMPT (Messenger-style) ===== */
    .request-prompt {
      padding: 20px 28px;
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.04), rgba(255, 183, 77, 0.04));
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      text-align: center;
      flex-shrink: 0;
    }

    .request-prompt .prompt-text {
      font-size: 0.92rem;
      color: var(--text-body);
      margin-bottom: 14px;
      line-height: 1.5;
    }

    .request-prompt .prompt-text strong {
      color: var(--text-main);
    }

    .request-prompt .prompt-subtext {
      font-size: 0.78rem;
      color: var(--text-light);
      margin-bottom: 16px;
    }

    .request-prompt .prompt-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .request-prompt .prompt-btn {
      padding: 10px 28px;
      border: none;
      border-radius: var(--radius-full);
      font-family: var(--font-body);
      font-size: 0.88rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .request-prompt .prompt-btn-accept {
      background: linear-gradient(135deg, var(--primary-color), #ee5a6f);
      color: white;
      box-shadow: 0 4px 14px rgba(255, 107, 107, 0.3);
    }

    .request-prompt .prompt-btn-accept:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
    }

    .request-prompt .prompt-btn-decline {
      background: var(--bg-light);
      color: var(--text-light);
    }

    .request-prompt .prompt-btn-decline:hover {
      background: #eee;
      color: var(--text-body);
    }

    .request-prompt .prompt-waiting {
      font-size: 0.85rem;
      color: var(--text-light);
      padding: 8px 0;
    }

    .request-prompt .prompt-waiting i {
      color: #f59f00;
      margin-right: 6px;
    }

    .toast-msg.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .toast-msg.ok {
      background: var(--success-color);
    }

    .toast-msg.fail {
      background: var(--danger-color);
    }

    /* ===== MOBILE RESPONSIVE ===== */
    @media (max-width: 768px) {
      .chat-page {
        grid-template-columns: 1fr;
        height: calc(100vh - 140px);
        border-radius: 0;
      }

      .panel-left {
        display: none;
      }

      .panel-left.mobile-open {
        display: flex;
        position: fixed;
        inset: 60px 0 60px 0;
        z-index: 999;
        background: white;
        border-radius: 0;
      }

      .mobile-back-btn {
        display: inline-flex !important;
      }
    }

    @media (min-width: 769px) {
      .mobile-back-btn {
        display: none !important;
      }
    }
  </style>
</head>

<body>

  <!-- Settings Overlay -->
  <div class="settings-overlay" id="settingsOverlay" onclick="closeSettings()"></div>
  <!-- Settings Panel -->
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-header">
      <h3><i class="fas fa-cog"></i>&nbsp; Settings</h3>
      <button class="settings-close" onclick="closeSettings()"><i class="fas fa-times"></i></button>
    </div>
    <div class="settings-body">
      <div class="setting-item">
        <div class="setting-label">
          <i class="setting-icon dark-icon"><i class="fas fa-moon"></i></i>
          <div>
            <div class="setting-name">Dark Mode</div>
            <div class="setting-desc">Switch between light &amp; dark themes</div>
          </div>
        </div>
        <label class="theme-toggle">
          <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
          <div class="theme-toggle-track"></div>
          <div class="theme-toggle-thumb"></div>
        </label>
      </div>
    </div>
  </div>
  <!-- ===== NAVBAR ===== -->
  <nav class="navbar" style="position:fixed;width:100%;z-index:1000;">
    <div class="container nav-container" style="max-width:100%;">
      <a th:href="@{/index}" class="logo">
        <i class="fas fa-heart" style="color:var(--primary-color);"></i> BiyeShaddi.com
      </a>
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-weight:600;color:var(--text-main);" th:text="${emailId}">User</span>
        <form th:action="@{/logout}" method="post" style="display:inline;">
          <button type="submit" class="btn btn-outline"
            style="padding:4px 12px;font-size:0.8rem;color:var(--text-main);border-color:#ddd;">Logout</button>
        </form>
      </div>
    </div>
  </nav>

  <div class="dashboard-layout">
    <!-- ===== SIDEBAR ===== -->
    <aside class="sidebar">
      <div style="margin-bottom:20px;">
        <a th:href="@{/discover(emailId=${emailId})}" class="sidebar-link">
          <i class="fas fa-compass"></i> Discover
        </a>
        <a th:href="@{/matches(emailId=${emailId})}" class="sidebar-link">
          <i class="fas fa-heart"></i> Matches
        </a>
        <a th:href="@{/talkrequest(emailId=${emailId})}" class="sidebar-link active">
          <i class="fas fa-comment-dots"></i> Messages
        </a>
        <a th:href="@{/user_dashboard(emailId=${emailId})}" class="sidebar-link">
          <i class="fas fa-user-edit"></i> Edit Profile
        </a>
        <a th:href="@{/user_info(emailId=${emailId})}" class="sidebar-link">
          <i class="fas fa-user"></i> View Profile
        </a>
        <button class="sidebar-settings-btn" onclick="openSettings()">
          <i class="fas fa-cog"></i> Settings
        </button>
      </div>
    </aside>

    <!-- ===== MAIN CONTENT ===== -->
    <main class="main-content" style="padding-top:70px;">
      <div class="chat-page">

        <!-- =========== LEFT PANEL =========== -->
        <div class="panel-left" id="panelLeft">

          <div class="panel-header">
            <div class="panel-title">Messages</div>

            <!-- Tabs -->
            <div class="tab-bar">
              <button class="tab-btn active" data-tab="chats" onclick="switchTab('chats')">
                <i class="fas fa-comment-dots"></i> Chats
              </button>
              <button class="tab-btn" data-tab="received" onclick="switchTab('received')">
                <i class="fas fa-inbox"></i> Requests
                <span class="tab-count" th:if="${senders != null && !senders.isEmpty()}"
                  th:text="${#lists.size(senders)}">0</span>
              </button>
              <button class="tab-btn" data-tab="sent" onclick="switchTab('sent')">
                <i class="fas fa-paper-plane"></i> Sent
              </button>
            </div>
          </div>

          <!-- Search -->
          <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search conversations..." oninput="filterList()" />
          </div>

          <!-- ===== CHATS TAB ===== -->
          <div class="convo-list" id="tab-chats">
            <div th:if="${chatPartners == null || chatPartners.isEmpty()}" class="list-empty">
              <div class="empty-icon"><i class="fas fa-comments"></i></div>
              <p><strong>No conversations yet</strong></p>
              <p>Send interest from Discover to start chatting!</p>
            </div>
            <div th:each="partner : ${chatPartners}" class="convo-item" th:data-email="${partner.emailId}"
              th:data-name="${partner.name}" onclick="openChat(this.dataset.email, this.dataset.name)">
              <div class="avatar" th:classappend="'gradient-' + ${(#strings.length(partner.emailId) % 6) + 1}"
                th:text="${partner.name != null ? partner.name.substring(0,1).toUpperCase() : '?'}">T
                <span class="online-indicator"></span>
              </div>
              <div class="convo-details">
                <div class="convo-name" th:text="${partner.name}">Name</div>
                <div class="convo-preview">Tap to start chatting</div>
              </div>
              <div class="convo-meta">
                <div class="convo-time"></div>
              </div>
            </div>
          </div>

          <!-- ===== RECEIVED TAB ===== -->
          <div class="convo-list" id="tab-received" style="display:none;">
            <div th:if="${senders == null || senders.isEmpty()}" class="list-empty">
              <div class="empty-icon"><i class="fas fa-inbox"></i></div>
              <p><strong>No pending requests</strong></p>
              <p>When someone sends you interest, it shows here</p>
            </div>
            <div th:each="sender, iter : ${senders}" class="req-card">
              <div class="avatar avatar-sm" th:classappend="'gradient-' + ${(#strings.length(sender.emailId) % 6) + 1}"
                th:text="${sender.name != null ? sender.name.substring(0,1).toUpperCase() : '?'}">T</div>
              <div class="req-details">
                <div class="req-name" th:text="${sender.name}">Name</div>
                <div class="req-sub">
                  <i class="fas fa-heart" style="color:var(--primary-color);font-size:0.65rem;"></i>
                  Wants to connect with you
                </div>
              </div>
              <div class="req-actions">
                <button class="btn-action btn-accept accept-btn"
                  th:data-request-id="${pendingRequests[__${iter.index}__].id}" th:data-email-id="${emailId}"
                  th:data-sender-email="${sender.emailId}" th:data-sender-name="${sender.name}">
                  <i class="fas fa-check"></i> Accept
                </button>
                <button class="btn-action btn-reject reject-btn"
                  th:data-request-id="${pendingRequests[__${iter.index}__].id}" th:data-email-id="${emailId}">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- ===== SENT TAB ===== -->
          <div class="convo-list" id="tab-sent" style="display:none;">
            <div th:if="${sentRequests == null || sentRequests.isEmpty()}" class="list-empty">
              <div class="empty-icon"><i class="fas fa-paper-plane"></i></div>
              <p><strong>No sent requests</strong></p>
              <p>Your outgoing interest requests appear here</p>
            </div>
            <div th:each="request : ${sentRequests}" class="req-card">
              <div class="avatar avatar-sm"
                th:classappend="'gradient-' + ${(request.toUser != null && request.toUser.emailId != null ? #strings.length(request.toUser.emailId) % 6 : 0) + 1}"
                th:text="${request.toUser != null && request.toUser.name != null ? request.toUser.name.substring(0,1).toUpperCase() : '?'}">
                T</div>
              <div class="req-details">
                <div class="req-name" th:text="${request.toUser != null ? request.toUser.name : 'Unknown'}">Name</div>
                <div class="req-sub" style="margin-top:4px;">
                  <span class="badge-status"
                    th:classappend="${request.status == 'PENDING' ? 'badge-pending' : request.status == 'ACCEPTED' ? 'badge-accepted-sm' : 'badge-rejected-sm'}"
                    th:text="${request.status}">PENDING</span>
                </div>
              </div>
              <div th:if="${request.status == 'ACCEPTED'}">
                <button class="btn-chat-sm" th:data-email="${request.toUser.emailId}"
                  th:data-name="${request.toUser.name}"
                  onclick="openChat(this.dataset.email, this.dataset.name); switchTab('chats');">
                  <i class="fas fa-comment-dots"></i> Chat
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- =========== RIGHT PANEL =========== -->
        <div class="panel-right" id="panelRight">

          <!-- Placeholder (no chat selected) -->
          <div class="chat-placeholder" id="chatPlaceholder">
            <div class="placeholder-illustration">
              <i class="far fa-comment-dots"></i>
            </div>
            <div class="placeholder-title">Start a Conversation</div>
            <div class="placeholder-desc">Select someone from your chats or accept a new request to begin messaging
            </div>
          </div>

          <!-- Active Chat (hidden by default) -->
          <div id="activeChat" style="display:none;flex-direction:column;height:100%;">

            <!-- Chat Top Bar -->
            <div class="chat-top-bar">
              <button class="icon-btn mobile-back-btn" onclick="closeChat()" style="display:none;">
                <i class="fas fa-arrow-left"></i>
              </button>
              <div class="avatar avatar-sm" id="chatAvatar" style="width:42px;height:42px;">T</div>
              <div class="chat-top-info">
                <h4 id="chatName">Name</h4>
                <span><span class="dot-online"></span> Online</span>
              </div>
              <div class="chat-top-actions">
                <button class="icon-btn" title="More options"><i class="fas fa-ellipsis-v"></i></button>
              </div>
            </div>

            <!-- Messages -->
            <div class="messages-area" id="messagesArea"></div>

            <!-- Message Request Prompt (Messenger-style) -->
            <div class="request-prompt" id="requestPrompt" style="display:none;">
              <div class="prompt-text" id="promptText"></div>
              <div class="prompt-subtext">If you accept, you'll be able to chat with each other</div>
              <div class="prompt-actions" id="promptActions"></div>
            </div>

            <!-- Compose -->
            <div class="compose-bar" id="composeBar">
              <input type="text" class="compose-input" id="msgInput" placeholder="Type your message..."
                autocomplete="off" />
              <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Bottom Nav (Mobile) -->
  <div class="bottom-nav">
    <a th:href="@{/discover(emailId=${emailId})}" class="nav-item">
      <i class="fas fa-compass"></i><span>Discover</span>
    </a>
    <a th:href="@{/matches(emailId=${emailId})}" class="nav-item">
      <i class="fas fa-heart"></i><span>Matches</span>
    </a>
    <a th:href="@{/talkrequest(emailId=${emailId})}" class="nav-item active">
      <i class="fas fa-comment-dots"></i><span>Chats</span>
    </a>
    <a th:href="@{/user_info(emailId=${emailId})}" class="nav-item">
      <i class="fas fa-user"></i><span>Profile</span>
    </a>
  </div>

  <!-- Toast -->
  <div id="toastEl" class="toast-msg"></div>

  <!-- ===== JAVASCRIPT ===== -->
  <script th:inline="javascript">
    /*<![CDATA[*/
    const ME = /*[[${emailId}]]*/ '';
    const CSRF_TOKEN = document.querySelector('meta[name="_csrf"]').content;
    const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]').content;

    let stomp = null;
    let activePeer = null;

    /* ===== WEBSOCKET ===== */
    function connectWS() {
      const sock = new SockJS('/ws');
      stomp = Stomp.over(sock);
      stomp.debug = null;

      stomp.connect({}, function () {
        stomp.subscribe('/user/' + ME + '/queue/messages', function (frame) {
          const msg = JSON.parse(frame.body);
          onMessage(msg);
        });
      }, function () {
        setTimeout(connectWS, 5000);
      });
    }

    function onMessage(msg) {
      if (activePeer && (msg.senderId === activePeer || msg.receiverId === activePeer)) {
        if (!document.getElementById('m-' + msg.id)) {
          // Check if this is the echo of our own optimistic bubble
          if (msg.senderId === ME) {
            // Find the temp bubble and replace its ID
            const tempBubbles = document.querySelectorAll('[id^="m-temp-"]');
            if (tempBubbles.length > 0) {
              tempBubbles[0].id = 'm-' + msg.id;
              return; // Already rendered optimistically
            }
          }
          renderBubble(msg);
          scrollDown();
          if (msg.receiverId === ME) markRead(msg.senderId);
        }
      } else {
        toast('New message received!', 'ok');
        setSidebarPreview(msg.senderId, msg.content);
      }
    }

    /* ===== TABS ===== */
    function switchTab(t) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('.tab-btn[data-tab="' + t + '"]').classList.add('active');
      document.getElementById('tab-chats').style.display = t === 'chats' ? '' : 'none';
      document.getElementById('tab-received').style.display = t === 'received' ? '' : 'none';
      document.getElementById('tab-sent').style.display = t === 'sent' ? '' : 'none';
    }

    /* ===== SEARCH FILTER ===== */
    function filterList() {
      const q = document.getElementById('searchInput').value.toLowerCase();
      document.querySelectorAll('.convo-item, .req-card').forEach(el => {
        const name = (el.dataset.name || el.querySelector('.convo-name, .req-name')?.textContent || '').toLowerCase();
        el.style.display = name.includes(q) ? '' : 'none';
      });
    }

    /* ===== OPEN CHAT ===== */
    let pendingRequestId = null; // Track the request ID for accept/decline

    function openChat(email, name) {
      activePeer = email;
      document.getElementById('chatName').textContent = name;
      const av = document.getElementById('chatAvatar');
      av.textContent = name ? name.charAt(0).toUpperCase() : '?';
      av.className = 'avatar avatar-sm gradient-' + ((email.length % 6) + 1);

      document.getElementById('chatPlaceholder').style.display = 'none';
      document.getElementById('activeChat').style.display = 'flex';

      // Hide both prompt and compose bar until we know the status
      document.getElementById('requestPrompt').style.display = 'none';
      document.getElementById('composeBar').style.display = 'none';

      document.querySelectorAll('.convo-item').forEach(c => c.classList.remove('selected'));
      const sel = document.querySelector('.convo-item[data-email="' + email + '"]');
      if (sel) sel.classList.add('selected');

      loadHistory(email);

      // Check connection status to decide compose bar vs acceptance prompt
      $.get('/api/talk-requests/connection-status', { userEmail: ME, peerEmail: email }, function (data) {
        if (data.status === 'ACCEPTED') {
          // Already accepted â€” show compose bar
          showComposeBar();
          markRead(email);
        } else if (data.status === 'PENDING' && data.direction === 'received') {
          // Pending request TO me â€” show acceptance prompt
          pendingRequestId = data.requestId;
          showRequestPrompt(name, 'received');
        } else if (data.status === 'PENDING' && data.direction === 'sent') {
          // I sent the request, waiting for them
          showRequestPrompt(name, 'sent');
        } else {
          // No request exists â€” show compose bar (fallback)
          showComposeBar();
        }
      }).fail(function () {
        // On error, default to compose bar
        showComposeBar();
      });
    }

    function showComposeBar() {
      document.getElementById('requestPrompt').style.display = 'none';
      document.getElementById('composeBar').style.display = 'flex';
      document.getElementById('msgInput').focus();
    }

    function showRequestPrompt(name, direction) {
      const prompt = document.getElementById('requestPrompt');
      const promptText = document.getElementById('promptText');
      const promptActions = document.getElementById('promptActions');

      prompt.style.display = 'block';
      document.getElementById('composeBar').style.display = 'none';

      if (direction === 'received') {
        promptText.innerHTML = '<strong>' + name + '</strong> wants to connect with you.<br>Do you want to accept the message request?';
        promptActions.innerHTML =
          '<button class="prompt-btn prompt-btn-accept" onclick="acceptFromChat()">' +
          '<i class="fas fa-check"></i>&nbsp; Accept</button>' +
          '<button class="prompt-btn prompt-btn-decline" onclick="declineFromChat()">' +
          '<i class="fas fa-times"></i>&nbsp; Decline</button>';
      } else {
        promptText.innerHTML = 'You sent a request to <strong>' + name + '</strong>.';
        promptActions.innerHTML =
          '<div class="prompt-waiting"><i class="fas fa-clock"></i> Waiting for them to accept your request</div>';
      }
    }

    function acceptFromChat() {
      if (!pendingRequestId) return;
      const actions = document.getElementById('promptActions');
      actions.innerHTML = '<button class="prompt-btn prompt-btn-accept" disabled><i class="fas fa-spinner fa-spin"></i>&nbsp; Accepting...</button>';

      $.ajax({
        url: '/api/talk-requests/accept/' + pendingRequestId, method: 'POST',
        headers: { [CSRF_HEADER]: CSRF_TOKEN }, data: { emailId: ME },
        success: function () {
          toast('Request accepted! You can now chat ðŸŽ‰', 'ok');
          showComposeBar();
          pendingRequestId = null;

          // Add them to chat partners list if not already there
          const peerName = document.getElementById('chatName').textContent;
          addPartnerToList(activePeer, peerName);

          // Remove from requests tab
          document.querySelectorAll('.req-card .accept-btn').forEach(function (btn) {
            if (btn.dataset.senderEmail === activePeer) {
              btn.closest('.req-card').remove();
            }
          });

          // Update tab badge
          const badge = document.querySelector('.tab-btn[data-tab="received"] .tab-count');
          if (badge) {
            const c = parseInt(badge.textContent) - 1;
            if (c <= 0) badge.remove();
            else badge.textContent = c;
          }
          markRead(activePeer);
        },
        error: function () {
          toast('Error accepting request', 'fail');
          actions.innerHTML =
            '<button class="prompt-btn prompt-btn-accept" onclick="acceptFromChat()">' +
            '<i class="fas fa-check"></i>&nbsp; Accept</button>' +
            '<button class="prompt-btn prompt-btn-decline" onclick="declineFromChat()">' +
            '<i class="fas fa-times"></i>&nbsp; Decline</button>';
        }
      });
    }

    function declineFromChat() {
      if (!pendingRequestId) return;
      const actions = document.getElementById('promptActions');
      actions.innerHTML = '<button class="prompt-btn prompt-btn-decline" disabled><i class="fas fa-spinner fa-spin"></i>&nbsp; Declining...</button>';

      $.ajax({
        url: '/api/talk-requests/reject/' + pendingRequestId, method: 'POST',
        headers: { [CSRF_HEADER]: CSRF_TOKEN }, data: { emailId: ME },
        success: function () {
          toast('Request declined');
          pendingRequestId = null;
          closeChat();

          // Remove from requests tab
          document.querySelectorAll('.req-card .reject-btn').forEach(function (btn) {
            if (btn.dataset.requestId === pendingRequestId) {
              btn.closest('.req-card').remove();
            }
          });
        },
        error: function () {
          toast('Error declining request', 'fail');
          actions.innerHTML =
            '<button class="prompt-btn prompt-btn-accept" onclick="acceptFromChat()">' +
            '<i class="fas fa-check"></i>&nbsp; Accept</button>' +
            '<button class="prompt-btn prompt-btn-decline" onclick="declineFromChat()">' +
            '<i class="fas fa-times"></i>&nbsp; Decline</button>';
        }
      });
    }

    function closeChat() {
      activePeer = null;
      document.getElementById('chatPlaceholder').style.display = '';
      document.getElementById('activeChat').style.display = 'none';
    }

    /* ===== LOAD HISTORY ===== */
    function loadHistory(peer) {
      const area = document.getElementById('messagesArea');
      area.innerHTML = '<div style="text-align:center;padding:60px;color:#ccc;"><i class="fas fa-circle-notch fa-spin fa-2x"></i></div>';

      $.get('/api/chat/history', { userId1: ME, userId2: peer }, function (msgs) {
        area.innerHTML = '';
        if (!msgs.length) {
          area.innerHTML = '<div class="msg-welcome"><i class="far fa-hand-peace"></i>Say hello! ðŸ‘‹</div>';
          return;
        }
        let lastDate = '';
        msgs.forEach(function (m) {
          const d = new Date(m.timestamp).toLocaleDateString();
          if (d !== lastDate) { lastDate = d; addDateSep(m.timestamp); }
          renderBubble(m);
        });
        scrollDown();
      }).fail(function () {
        area.innerHTML = '<div style="text-align:center;padding:60px;color:var(--danger-color);">Failed to load messages</div>';
      });
    }

    /* ===== RENDER BUBBLE ===== */
    function renderBubble(m) {
      const area = document.getElementById('messagesArea');
      const me = m.senderId === ME;
      const el = document.createElement('div');
      el.className = 'bubble ' + (me ? 'bubble-out' : 'bubble-in');
      el.id = 'm-' + m.id;

      const txt = document.createElement('div');
      txt.textContent = m.content;
      const ts = document.createElement('div');
      ts.className = 'bubble-ts';
      ts.textContent = fmtTime(m.timestamp);

      el.appendChild(txt);
      el.appendChild(ts);
      area.appendChild(el);
    }

    function addDateSep(ts) {
      const area = document.getElementById('messagesArea');
      const d = document.createElement('div');
      d.className = 'date-separator';
      d.innerHTML = '<span>' + fmtDateLabel(ts) + '</span>';
      area.appendChild(d);
    }

    /* ===== SEND MESSAGE ===== */
    let tempMsgCounter = 0;

    function sendMessage() {
      const input = document.getElementById('msgInput');
      const text = input.value.trim();
      if (!text || !activePeer) return;

      // Optimistic local bubble â€” appears instantly
      const tempId = 'temp-' + (++tempMsgCounter);
      renderBubble({ id: tempId, senderId: ME, content: text, timestamp: new Date().toISOString() });
      scrollDown();
      input.value = '';
      input.focus();
      setSidebarPreview(activePeer, text);

      if (stomp && stomp.connected) {
        stomp.send('/app/chat.send', {}, JSON.stringify({
          senderId: ME, receiverId: activePeer, content: text
        }));
      } else {
        $.ajax({
          url: '/api/chat/send', type: 'POST',
          data: { senderId: ME, receiverId: activePeer, content: text },
          beforeSend: function (xhr) { xhr.setRequestHeader(CSRF_HEADER, CSRF_TOKEN); },
          success: function (m) {
            // Replace temp bubble with real one
            const tempEl = document.getElementById('m-' + tempId);
            if (tempEl) tempEl.id = 'm-' + m.id;
          },
          error: function () {
            // Remove temp bubble on failure
            const tempEl = document.getElementById('m-' + tempId);
            if (tempEl) tempEl.remove();
            toast('Send failed', 'fail');
          }
        });
      }
    }

    /* ===== MARK READ ===== */
    function markRead(sender) {
      $.ajax({
        url: '/api/chat/mark-read', type: 'POST',
        data: { senderEmail: sender, receiverEmail: ME },
        beforeSend: function (xhr) { xhr.setRequestHeader(CSRF_HEADER, CSRF_TOKEN); }
      });
    }

    /* ===== ACCEPT / REJECT ===== */
    $(document).on('click', '.accept-btn', function () {
      const btn = $(this);
      const id = btn.data('request-id'), eid = btn.data('email-id');
      const sEmail = btn.data('sender-email'), sName = btn.data('sender-name');
      btn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);

      $.ajax({
        url: '/api/talk-requests/accept/' + id, method: 'POST',
        headers: { [CSRF_HEADER]: CSRF_TOKEN }, data: { emailId: eid },
        success: function () {
          btn.closest('.req-card').fadeOut(300, function () { $(this).remove(); });
          toast('Accepted! Start chatting now ðŸŽ‰', 'ok');
          addPartnerToList(sEmail, sName);

          // Update tab badge
          const badge = document.querySelector('.tab-btn[data-tab="received"] .tab-count');
          if (badge) {
            const c = parseInt(badge.textContent) - 1;
            if (c <= 0) badge.remove();
            else badge.textContent = c;
          }
        },
        error: function () {
          btn.html('<i class="fas fa-check"></i> Accept').prop('disabled', false);
          toast('Error accepting request', 'fail');
        }
      });
    });

    $(document).on('click', '.reject-btn', function () {
      const btn = $(this);
      const id = btn.data('request-id'), eid = btn.data('email-id');
      $.ajax({
        url: '/api/talk-requests/reject/' + id, method: 'POST',
        headers: { [CSRF_HEADER]: CSRF_TOKEN }, data: { emailId: eid },
        success: function () {
          btn.closest('.req-card').fadeOut(300, function () { $(this).remove(); });
          toast('Request declined');
        },
        error: function () { toast('Error', 'fail'); }
      });
    });

    /* ===== HELPERS ===== */
    function addPartnerToList(email, name) {
      if (document.querySelector('.convo-item[data-email="' + email + '"]')) return;
      const list = document.getElementById('tab-chats');
      const empty = list.querySelector('.list-empty');
      if (empty) empty.remove();

      const el = document.createElement('div');
      el.className = 'convo-item';
      el.dataset.email = email;
      el.dataset.name = name;
      el.onclick = function () { openChat(email, name); };
      el.innerHTML =
        '<div class="avatar gradient-' + ((email.length % 6) + 1) + '">' + (name ? name.charAt(0).toUpperCase() : '?') +
        '<span class="online-indicator"></span></div>' +
        '<div class="convo-details">' +
        '<div class="convo-name">' + name + '</div>' +
        '<div class="convo-preview">Tap to start chatting</div>' +
        '</div>' +
        '<div class="convo-meta"><div class="convo-time">Now</div></div>';
      list.prepend(el);
    }

    function setSidebarPreview(email, text) {
      const item = document.querySelector('.convo-item[data-email="' + email + '"]');
      if (!item) return;
      const prev = item.querySelector('.convo-preview');
      if (prev) prev.textContent = text.length > 30 ? text.substring(0, 30) + 'â€¦' : text;
      const t = item.querySelector('.convo-time');
      if (t) t.textContent = 'Now';
    }

    function scrollDown() {
      const a = document.getElementById('messagesArea');
      setTimeout(function () { a.scrollTop = a.scrollHeight; }, 60);
    }

    function fmtTime(ts) {
      const d = new Date(ts);
      let h = d.getHours(), m = String(d.getMinutes()).padStart(2, '0');
      const ap = h >= 12 ? 'PM' : 'AM';
      h = h % 12 || 12;
      return h + ':' + m + ' ' + ap;
    }

    function fmtDateLabel(ts) {
      const d = new Date(ts), now = new Date();
      const y = new Date(now); y.setDate(y.getDate() - 1);
      if (d.toDateString() === now.toDateString()) return 'Today';
      if (d.toDateString() === y.toDateString()) return 'Yesterday';
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function toast(msg, type) {
      const t = document.getElementById('toastEl');
      t.textContent = msg;
      t.className = 'toast-msg visible ' + (type || '');
      setTimeout(function () { t.className = 'toast-msg'; }, 2800);
    }

    // Enter key sends message
    document.getElementById('msgInput').addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    // Init
    connectWS();
    /*]]>*/
  </script>
</body>

</html>