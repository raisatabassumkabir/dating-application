<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}">
  <link rel="stylesheet" type="text/css" th:href="@{/css/dashboard.css}">

  <style>
    /* Inline overrides for this specific page layout */
    .inbox-tab {
      padding: 15px;
      text-align: center;
      cursor: pointer;
      background: #f8f9fa;
      border-bottom: 2px solid transparent;
      font-weight: 600;
      color: var(--text-light);
      flex: 1;
    }

    .inbox-tab.active {
      background: white;
      color: var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
    }
  </style>
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar" style="position: fixed; width: 100%; z-index: 1000;">
    <div class="container nav-container" style="max-width: 100%;">
      <a th:href="@{/index}" class="logo">
        <i class="fas fa-heart" style="color: var(--primary-color);"></i> BiyeShaddi.com
      </a>
      <div class="flex items-center gap-md">
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-weight: 600; color: var(--text-main);" th:text="${emailId}">User</span>
        </div>
      </div>
    </div>
  </nav>

  <div class="dashboard-layout">
    <aside class="sidebar">
      <div style="margin-bottom: 20px;">
        <a th:href="@{/matches(emailId=${emailId})}" class="sidebar-link">
          <i class="fas fa-fire"></i> New Matches
        </a>
        <a th:href="@{/matches(emailId=${emailId})}" class="sidebar-link">
          <i class="fas fa-heart"></i> Daily Recommendations
        </a>
        <a th:href="@{/talkrequest(emailId=${emailId})}" class="sidebar-link active">
          <i class="fas fa-comment-alt"></i> Messages
        </a>
        <a th:href="@{/user_dashboard(emailId=${emailId})}" class="sidebar-link">
          <i class="fas fa-user-edit"></i> Edit Profile
        </a>
        <a th:href="@{/user_info(emailId=${emailId})}" class="sidebar-link">
          <i class="fas fa-user"></i> View Profile
        </a>
      </div>
    </aside>

    <main class="main-content">
      <div class="container" style="height: calc(100vh - 120px); max-width: 1200px;">

        <h2 style="margin-bottom: 20px; color: var(--text-main);">Messages & Requests</h2>

        <div class="inbox-container">

          <!-- Inbox Sidebar (List) -->
          <div class="inbox-sidebar">
            <div style="display: flex; border-bottom: 1px solid #eee;">
              <div class="inbox-tab active" onclick="switchTab('received')">Received</div>
              <div class="inbox-tab" onclick="switchTab('sent')">Sent</div>
            </div>

            <!-- Received List -->
            <div id="received-list">
              <div th:if="${senders == null or senders.isEmpty()}"
                style="padding: 20px; text-align: center; color: var(--text-light);">
                <i class="fas fa-inbox fa-2x" style="margin-bottom: 10px; color: #eee;"></i>
                <p>No new requests</p>
              </div>

              <div th:each="sender, iter : ${senders}" class="request-item"
                th:onclick="showRequestDetails('received', [[${iter.index}]])">
                <img
                  th:src="${sender.profilePictureUrl != null ? sender.profilePictureUrl : '/images/default-profile.jpg'}"
                  class="request-avatar" alt="Profile">
                <div class="request-info">
                  <div class="request-name" th:text="${sender.name}">Name</div>
                  <div class="request-preview">
                    <i class="fas fa-magic" style="font-size: 0.7rem; color: var(--primary-color);"></i>
                    Wants to connect with you
                  </div>
                </div>
                <div class="request-time">Now</div>

                <!-- Hidden details for JS to grab -->
                <div th:id="'details-received-' + ${iter.index}" style="display:none;">
                  <div class="profile-card" style="box-shadow: none; border: 1px solid #eee; margin-bottom: 0;">
                    <div style="text-align: center; padding: 20px;">
                      <img
                        th:src="${sender.profilePictureUrl != null ? sender.profilePictureUrl : '/images/default-profile.jpg'}"
                        style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 15px;"
                        alt="Profile">
                      <h3 th:text="${sender.name}" style="margin-bottom: 5px;">Name</h3>
                      <p style="color: var(--text-light); margin-bottom: 15px;">
                        <span th:text="${sender.age}">25</span> yrs • <span
                          th:text="${sender.profession}">Profession</span> • <span
                          th:text="${sender.location}">Location</span>
                      </p>

                      <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                        <span class="badge badge-success"><i class="fas fa-check-circle"></i> Verified</span>
                        <span class="badge badge-success" style="background: #f0fdf4; color: #166534;"><i
                            class="fas fa-star"></i> Reference</span>
                      </div>

                      <div class="flex gap-md" style="justify-content: center;">
                        <button class="btn btn-primary accept-btn"
                          th:attr="data-request-id=${pendingRequests[iter.index].id},data-email-id=${emailId}">
                          Accept Request
                        </button>
                        <button class="btn btn-outline reject-btn"
                          th:attr="data-request-id=${pendingRequests[iter.index].id},data-email-id=${emailId}">
                          Decline
                        </button>
                      </div>
                      <div class="message" style="margin-top: 15px; font-weight: 500;"></div>
                    </div>

                    <div style="padding: 20px; border-top: 1px solid #eee; background: #fcfcfc;">
                      <h4 style="font-size: 0.9rem; margin-bottom: 10px; color: var(--text-light);">About</h4>
                      <p style="font-size: 0.9rem; color: var(--text-body); line-height: 1.5;" th:text="${sender.bio}">
                        Bio...</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sent List -->
            <div id="sent-list" style="display: none;">
              <div th:if="${sentRequests == null or sentRequests.isEmpty()}"
                style="padding: 20px; text-align: center; color: var(--text-light);">
                <p>No sent requests</p>
              </div>

              <div th:each="request : ${sentRequests}" class="request-item">
                <img
                  th:src="${request.toUser.profilePictureUrl != null ? request.toUser.profilePictureUrl : '/images/default-profile.jpg'}"
                  class="request-avatar" alt="Profile">
                <div class="request-info">
                  <div class="request-name" th:text="${request.toUser.name}">Name</div>
                  <div class="request-preview" style="color: var(--text-light);">
                    Status:
                    <span class="status-badge"
                      th:classappend="${request.status == 'PENDING' ? 'status-pending' : request.status == 'ACCEPTED' ? 'status-accepted' : 'status-rejected'}"
                      th:text="${request.status}">PENDING</span>
                  </div>
                </div>
                <div th:if="${request.status == 'ACCEPTED'}" style="font-size: 1.2rem; color: var(--primary-color);">
                  <a th:href="@{/contact_info(emailId=${emailId})}" title="View Contact"><i
                      class="fas fa-address-card"></i></a>
                </div>
              </div>
            </div>
          </div>

          <!-- Inbox Details (Right Pane) -->
          <div class="inbox-main" id="details-pane">
            <div class="chat-placeholder">
              <i class="far fa-comments"></i>
              <h3>Select a conversation</h3>
              <p>Choose a request from the list to view details and take action.</p>
            </div>
          </div>

        </div>

      </div>
    </main>
  </div>

  <!-- Bottom Nav (Mobile) -->
  <div class="bottom-nav">
    <a th:href="@{/matches(emailId=${emailId})}" class="nav-item">
      <i class="fas fa-fire"></i>
      <span>Matches</span>
    </a>
    <a th:href="@{/talkrequest(emailId=${emailId})}" class="nav-item active">
      <i class="fas fa-comment-alt"></i>
      <span>Chats</span>
    </a>
    <a th:href="@{/user_dashboard(emailId=${emailId})}" class="nav-item">
      <i class="fas fa-user-edit"></i>
      <span>Edit</span>
    </a>
    <a th:href="@{/user_info(emailId=${emailId})}" class="nav-item">
      <i class="fas fa-user"></i>
      <span>Profile</span>
    </a>
  </div>

  <script>
    const csrfToken = $('meta[name="_csrf"]').attr('content');
    const csrfHeader = $('meta[name="_csrf_header"]').attr('content');

    function switchTab(tab) {
      $('.inbox-tab').removeClass('active');
      if (tab === 'received') {
        $('.inbox-tab:first-child').addClass('active');
        $('#received-list').show();
        $('#sent-list').hide();
      } else {
        $('.inbox-tab:last-child').addClass('active');
        $('#received-list').hide();
        $('#sent-list').show();
      }
    }

    function showRequestDetails(type, index) {
      if (type === 'received') {
        const detailsHtml = $('#details-received-' + index).html();
        $('#details-pane').html(detailsHtml);
        attachActionHandlers(); // Re-attach JS listeners to new DOM elements
      }
    }

    function attachActionHandlers() {
      $('.accept-btn').off('click').click(function () {
        const $btn = $(this);
        const requestId = $btn.data('request-id');
        const emailId = $btn.data('email-id');
        const $msg = $btn.closest('.profile-card').find('.message');

        $btn.html('<i class="fas fa-spinner fa-spin"></i> Processing...');

        $.ajax({
          url: '/api/talk-requests/accept/' + requestId,
          method: 'POST',
          headers: { [csrfHeader]: csrfToken },
          data: { emailId: emailId },
          success: function (response) {
            $msg.text('Accepted! You can now view their contact details.').css('color', 'green');
            $btn.replaceWith('<button class="btn btn-outline" disabled style="color: green; border-color: green;"><i class="fas fa-check"></i> Accepted</button>');
          },
          error: function () {
            $msg.text('Error accepting request.').css('color', 'red');
          }
        });
      });

      $('.reject-btn').off('click').click(function () {
        // Logic for reject (omitted for brevity, similar to accept)
        alert('Reject logic here');
      });
    }
  </script>
</body>

</html>